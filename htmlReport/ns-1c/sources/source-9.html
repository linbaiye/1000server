


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RealmEntityEventSender</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.y1000.realm</a>
</div>

<h1>Coverage Summary for Class: RealmEntityEventSender (org.y1000.realm)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RealmEntityEventSender</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/90)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.y1000.realm;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.Validate;
&nbsp;import org.y1000.entities.*;
&nbsp;import org.y1000.entities.creatures.event.*;
&nbsp;import org.y1000.event.EntityEvent;
&nbsp;import org.y1000.event.EntityEventListener;
&nbsp;import org.y1000.entities.players.Player;
&nbsp;import org.y1000.entities.players.event.*;
&nbsp;import org.y1000.message.*;
&nbsp;import org.y1000.message.serverevent.JoinedRealmEvent;
&nbsp;import org.y1000.message.serverevent.*;
&nbsp;import org.y1000.network.Connection;
&nbsp;
&nbsp;import java.util.*;
&nbsp;
&nbsp;/**
&nbsp; * Responsible for sending events to visible clients.
&nbsp; */
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;final class RealmEntityEventSender implements EntityEventListener,</b>
&nbsp;        PlayerEventVisitor, EntityEventSender {
&nbsp;
<b class="nc">&nbsp;    private final RelevantScopeManager scopeManager = new RelevantScopeManager();</b>
&nbsp;
<b class="nc">&nbsp;    private final Map&lt;Player, Connection&gt; playerConnectionMap = new HashMap&lt;&gt;(100);</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(InputResponseMessage inputResponseMessage) {
<b class="nc">&nbsp;        sendMessage(inputResponseMessage.player(), inputResponseMessage);</b>
<b class="nc">&nbsp;        visit(inputResponseMessage.positionMessage());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void notifyInterpolation(Player joined, Entity entity) {
<b class="nc">&nbsp;        sendMessage(joined, entity.captureInterpolation());</b>
<b class="nc">&nbsp;        log.debug(&quot;Notified player {} of player {}&quot;, joined.id(), entity.id());</b>
<b class="nc">&nbsp;        if (entity instanceof Player another) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Notified player {} of player {}&quot;, another.id(), joined.id());</b>
<b class="nc">&nbsp;            sendMessage(another, joined.captureInterpolation());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void sendMessage(Player player, ServerMessage serverMessage) {
<b class="nc">&nbsp;        playerConnectionMap.get(player).write(serverMessage);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void notifyOutsightOrInsight(Entity moved,
&nbsp;                                         Entity affected) {
<b class="nc">&nbsp;        boolean outOfView = scopeManager.outOfScope(moved, affected);</b>
<b class="nc">&nbsp;        if (outOfView) {</b>
<b class="nc">&nbsp;            if (moved instanceof Player movedPlayer) {</b>
<b class="nc">&nbsp;                sendMessage(movedPlayer, new RemoveEntityMessage(affected.id()));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (affected instanceof Player affectedPlayer) {</b>
<b class="nc">&nbsp;                sendMessage(affectedPlayer, new RemoveEntityMessage(moved.id()));</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (moved instanceof Player movedPlayer) {</b>
<b class="nc">&nbsp;                sendMessage(movedPlayer, affected.captureInterpolation());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (affected instanceof Player affectedPlayer) {</b>
<b class="nc">&nbsp;                sendMessage(affectedPlayer, moved.captureInterpolation());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(AbstractPositionEvent positionEvent) {
<b class="nc">&nbsp;        Entity source = positionEvent.source();</b>
<b class="nc">&nbsp;        Set&lt;Entity&gt; affectedEntities = scopeManager.update(source);</b>
<b class="nc">&nbsp;        affectedEntities.forEach(entity -&gt; notifyOutsightOrInsight(source, entity));</b>
<b class="nc">&nbsp;        doNotifyVisiblePlayers(source, positionEvent);</b>
<b class="nc">&nbsp;        if (positionEvent.source() instanceof Player player) {</b>
<b class="nc">&nbsp;            sendMessage(player, positionEvent);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(JoinedRealmEvent joinedRealmEvent) {
<b class="nc">&nbsp;        sendMessage(joinedRealmEvent.player(), joinedRealmEvent);</b>
<b class="nc">&nbsp;        var visibleEntities = scopeManager.filterVisibleEntities(joinedRealmEvent.source(), Entity.class);</b>
<b class="nc">&nbsp;        visibleEntities.forEach(entity -&gt; notifyInterpolation(joinedRealmEvent.player(), entity));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void cleanEntity(Entity entity,
&nbsp;                             ServerMessage message) {
<b class="nc">&nbsp;        Set&lt;Player&gt; affected = scopeManager.filterVisibleEntities(entity, Player.class);</b>
<b class="nc">&nbsp;        affected.forEach(player -&gt; sendMessage(player, message));</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(CreatureAttackEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(RewindEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event.toSetPosition());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerAttackEventResponse event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
<b class="nc">&nbsp;        event.toPlayerAttackEvent()</b>
<b class="nc">&nbsp;                .ifPresent(e -&gt; doNotifyVisiblePlayers(event.source(), e));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void doNotifyVisiblePlayers(Entity source, ServerMessage serverMessage) {
<b class="nc">&nbsp;        scopeManager.filterVisibleEntities(source, Player.class)</b>
<b class="nc">&nbsp;                .forEach(player -&gt; sendMessage(player, serverMessage));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void notifyVisiblePlayers(Entity source, ServerMessage serverMessage) {
<b class="nc">&nbsp;        Validate.notNull(source, &quot;source can&#39;t be null.&quot;);</b>
<b class="nc">&nbsp;        Validate.notNull(serverMessage, &quot;serverMessage can&#39;t be null.&quot;);</b>
<b class="nc">&nbsp;        doNotifyVisiblePlayers(source, serverMessage);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerAttackEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(CreatureHurtEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void notifyVisiblePlayersAndSelf(Entity source,
&nbsp;                                             ServerMessage message) {
<b class="nc">&nbsp;        Validate.notNull(source);</b>
<b class="nc">&nbsp;        Validate.notNull(message);</b>
<b class="nc">&nbsp;        doNotifyVisiblePlayers(source, message);</b>
<b class="nc">&nbsp;        if (source instanceof Player player) {</b>
<b class="nc">&nbsp;            sendMessage(player, message);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(NpcChangeStateEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onEvent(EntityEvent entityEvent) {
<b class="nc">&nbsp;        entityEvent.accept(this);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(InventorySlotSwappedEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(UpdateInventorySlotEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerUnequipEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerEquipEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerTextEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerToggleKungFuEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerSitDownEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
<b class="nc">&nbsp;        if (event.isIncludeSelf()) {</b>
<b class="nc">&nbsp;            sendMessage(event.player(), event);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerStandUpEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
<b class="nc">&nbsp;        if (event.isIncludeSelf()) {</b>
<b class="nc">&nbsp;            sendMessage(event.player(), event);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerCooldownEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerAttackAoeEvent event) {
<b class="nc">&nbsp;        Set&lt;AttackableEntity&gt; entities = scopeManager.filterVisibleEntities(event.source(), AttackableEntity.class);</b>
<b class="nc">&nbsp;        event.affect(entities);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(CreatureDieEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerAttributeEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerReviveEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(EntitySoundEvent event) {
<b class="nc">&nbsp;        notifyVisiblePlayersAndSelf(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(RemoveEntityEvent event) {
<b class="nc">&nbsp;        cleanEntity(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(PlayerGainExpEvent event) {
<b class="nc">&nbsp;        sendMessage(event.player(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(MonsterShootEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(NpcMoveEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(ShowItemEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void visit(NpcJoinedEvent event) {
<b class="nc">&nbsp;        doNotifyVisiblePlayers(event.source(), event);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public void add(Player player, Connection connection) {
<b class="nc">&nbsp;        playerConnectionMap.put(player, connection);</b>
<b class="nc">&nbsp;        add(player);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean contains(Player player) {
<b class="nc">&nbsp;        return playerConnectionMap.containsKey(player);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void add(Entity entity) {
<b class="nc">&nbsp;        if (scopeManager.getAllEntities().contains(entity)) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        scopeManager.add(entity);</b>
<b class="nc">&nbsp;        entity.registerEventListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void remove(Entity entity) {
<b class="nc">&nbsp;        scopeManager.remove(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendEvent(EntityEvent entityEvent) {
<b class="nc">&nbsp;        entityEvent.accept(this);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void notifySelf(AbstractPlayerEvent playerEvent) {
<b class="nc">&nbsp;        Validate.notNull(playerEvent);</b>
<b class="nc">&nbsp;        sendMessage(playerEvent.player(), playerEvent);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void remove(Player player) {
<b class="nc">&nbsp;        scopeManager.remove(player);</b>
<b class="nc">&nbsp;        playerConnectionMap.remove(player);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-07-18 11:06</div>
</div>
</body>
</html>
