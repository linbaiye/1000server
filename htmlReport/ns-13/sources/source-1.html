


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AbstractAttackKungFu</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.y1000.kungfu.attack</a>
</div>

<h1>Coverage Summary for Class: AbstractAttackKungFu (org.y1000.kungfu.attack)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AbstractAttackKungFu</td>
<td class="coverageStat">
  <span class="percent">
    90.3%
  </span>
  <span class="absValue">
    (28/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    94.9%
  </span>
  <span class="absValue">
    (93/98)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AbstractAttackKungFu$DamageMultiplier</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    91.2%
  </span>
  <span class="absValue">
    (31/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95%
  </span>
  <span class="absValue">
    (96/101)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.y1000.kungfu.attack;
&nbsp;
&nbsp;import lombok.Getter;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.y1000.entities.AttackableEntity;
&nbsp;import org.y1000.entities.Direction;
&nbsp;import org.y1000.entities.players.*;
&nbsp;import org.y1000.entities.creatures.State;
&nbsp;import org.y1000.entities.creatures.event.EntitySoundEvent;
&nbsp;import org.y1000.entities.players.event.*;
&nbsp;import org.y1000.entities.players.fight.*;
&nbsp;import org.y1000.kungfu.AbstractKungFu;
&nbsp;import org.y1000.kungfu.KungFuType;
&nbsp;import org.y1000.message.PlayerTextEvent;
&nbsp;import org.y1000.message.clientevent.ClientAttackEvent;
&nbsp;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Getter
&nbsp;public abstract class AbstractAttackKungFu extends AbstractKungFu implements AttackKungFu {
&nbsp;
&nbsp;
&nbsp;    protected AbstractAttackKungFu(String name, int exp, AttackKungFuParameters parameters) {
<b class="fc">&nbsp;        super(name, exp);</b>
<b class="fc">&nbsp;        this.parameters = parameters;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private record DamageMultiplier(int levelStart, int levelEnd, int multiplier) {</b>
&nbsp;        public boolean contains(int skillLevel) {
<b class="fc">&nbsp;            return levelEnd &gt;= skillLevel &amp;&amp; levelStart &lt;= skillLevel;</b>
&nbsp;        }
&nbsp;
&nbsp;        public int multiply(int damage) {
<b class="fc">&nbsp;            return damage + multiplier * damage / 100;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private static final List&lt;DamageMultiplier&gt; DAMAGE_MULTIPLIERS = List.of(</b>
&nbsp;            new DamageMultiplier(0,4999,0),
&nbsp;            new DamageMultiplier(5000,5999,2),
&nbsp;            new DamageMultiplier(6000,6999,6),
&nbsp;            new DamageMultiplier(7000,7999,10),
&nbsp;            new DamageMultiplier(8000,8999,15),
&nbsp;            new DamageMultiplier(9000,9998,20),
&nbsp;            new DamageMultiplier(9999,9999,25)
&nbsp;    );
&nbsp;
&nbsp;    private static final int INIT_SKILL_DIV_DAMAGE = 5000;
&nbsp;
&nbsp;    private static final int INIT_SKILL_DIV_ATTACKSPEED = 25000;
&nbsp;
&nbsp;    private static final int INIT_SKILL_DIV_ARMOR = 5000;
&nbsp;
&nbsp;    /*
&nbsp;    p^.rLifeData.damageBody + p^.rLifeData.damageBody * p^.rcSkillLevel div INI_SKILL_DIV_DAMAGE;
&nbsp;     */
&nbsp;
<b class="nc">&nbsp;    private final AttackKungFuParameters parameters;</b>
&nbsp;
&nbsp;    protected abstract Logger logger();
&nbsp;
&nbsp;    protected PlayerTextEvent checkAttributeResources(PlayerImpl player) {
<b class="fc">&nbsp;        if (player.power() &lt; parameters.powerToSwing()) {</b>
<b class="fc">&nbsp;            return PlayerTextEvent.noPower(player);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (player.innerPower() &lt; parameters.innerPowerToSwing()) {</b>
<b class="nc">&nbsp;            return PlayerTextEvent.noInnerPower(player);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (player.outerPower() &lt; parameters.outerPowerToSwing()) {</b>
<b class="nc">&nbsp;            return PlayerTextEvent.noOuterPower(player);</b>
&nbsp;        }
<b class="fc">&nbsp;        int lifeToSwing = parameters.lifeToSwing();</b>
<b class="fc">&nbsp;        if (player.currentLife() &lt;= lifeToSwing) {</b>
<b class="fc">&nbsp;            return PlayerTextEvent.insufficientLife(player);</b>
&nbsp;        }
<b class="fc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected abstract PlayerTextEvent checkResources(PlayerImpl player);
&nbsp;
&nbsp;    protected boolean useAttributeResources(PlayerImpl player) {
<b class="fc">&nbsp;        var ret = checkAttributeResources(player);</b>
<b class="fc">&nbsp;        if (ret != null) {</b>
<b class="fc">&nbsp;            player.emitEvent(ret);</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="fc">&nbsp;        player.consumeLife(parameters.lifeToSwing());</b>
<b class="fc">&nbsp;        player.consumeOuterPower(parameters.outerPowerToSwing());</b>
<b class="fc">&nbsp;        player.consumeInnerPower(parameters.innerPowerToSwing());</b>
<b class="fc">&nbsp;        player.consumePower(parameters.powerToSwing());</b>
<b class="fc">&nbsp;        player.emitEvent(new PlayerAttributeEvent(player));</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected abstract boolean useResources(PlayerImpl player);
&nbsp;
&nbsp;
&nbsp;    private String computeSound(int nr) {
<b class="fc">&nbsp;        if (level() &lt; 5000) {</b>
<b class="fc">&nbsp;            return String.valueOf(nr);</b>
&nbsp;        }
<b class="fc">&nbsp;        return level() &lt; 5000 ? String.valueOf(nr) :</b>
<b class="fc">&nbsp;                String.valueOf(level() &gt; 8999 ? nr + 4 : nr + 2);</b>
&nbsp;    }
&nbsp;
&nbsp;    public String strikeSound() {
<b class="fc">&nbsp;        return computeSound(parameters.strikeSound());</b>
&nbsp;    }
&nbsp;
&nbsp;    public String swingSound() {
<b class="fc">&nbsp;        return computeSound(parameters.swingSound());</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private void doSingleAttack(PlayerImpl player) {
<b class="fc">&nbsp;        var hit = player.getFightingEntity().attackedBy(player);</b>
<b class="fc">&nbsp;        player.emitEvent(new EntitySoundEvent(player, hit ? strikeSound() : swingSound()));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void doAttack(PlayerImpl player, Direction direction, boolean sendAttackEvent) {
<b class="fc">&nbsp;        int cooldown = player.cooldown();</b>
<b class="fc">&nbsp;        if (cooldown &gt; 0) {</b>
<b class="fc">&nbsp;            player.changeState(new PlayerCooldownState(cooldown));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        if (!isRanged() &amp;&amp; player.getFightingEntity().coordinate().directDistance(player.coordinate()) &gt; 1) {</b>
<b class="fc">&nbsp;            player.changeState(new PlayerWaitDistanceState(player.getStateMillis(State.COOLDOWN)));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        if (!useResources(player)) {</b>
<b class="fc">&nbsp;            player.changeState(new PlayerCooldownState(player.getStateMillis(State.COOLDOWN)));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        player.changeDirection(direction);</b>
<b class="fc">&nbsp;        player.cooldownAttack();</b>
<b class="fc">&nbsp;        player.changeState(PlayerAttackState.of(player));</b>
<b class="fc">&nbsp;        if (sendAttackEvent)</b>
<b class="fc">&nbsp;            player.emitEvent(PlayerAttackEvent.of(player, player.getFightingEntity().id()));</b>
<b class="fc">&nbsp;        if (!isRanged()) {</b>
<b class="fc">&nbsp;            player.assistantKungFu().ifPresentOrElse(</b>
<b class="nc">&nbsp;                    assistantKungFu -&gt; player.emitEvent(PlayerAttackAoeEvent.melee(player, player.getFightingEntity(), assistantKungFu)),</b>
<b class="fc">&nbsp;                    () -&gt; doSingleAttack(player));</b>
&nbsp;        } else {
<b class="fc">&nbsp;            player.emitEvent(new EntitySoundEvent(player, swingSound()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void attackAgain(PlayerImpl player) {
<b class="fc">&nbsp;        if (player.getFightingEntity() == null || !player.canPurchaseOrAttack(player.getFightingEntity())) {</b>
<b class="fc">&nbsp;            player.changeState(PlayerStillState.chillOut(player));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        Direction direction = player.coordinate().computeDirection(player.getFightingEntity().coordinate());</b>
<b class="fc">&nbsp;        doAttack(player, direction, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void doStartAttack(PlayerImpl player, ClientAttackEvent event, AttackableEntity target) {
<b class="fc">&nbsp;        if (!player.canPurchaseOrAttack(target)) {</b>
<b class="fc">&nbsp;            player.emitEvent(new PlayerAttackEventResponse(player, event, false));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        var text = checkResources(player);</b>
<b class="fc">&nbsp;        if (text != null) {</b>
<b class="fc">&nbsp;            player.emitEvent(text);</b>
<b class="fc">&nbsp;            player.emitEvent(new PlayerAttackEventResponse(player, event, false));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        Direction direction = event.direction();</b>
<b class="fc">&nbsp;        player.setFightingEntity(target);</b>
<b class="fc">&nbsp;        player.disableFootKungFuNoTip();</b>
<b class="fc">&nbsp;        player.disableBreathKungNoTip();</b>
<b class="fc">&nbsp;        doAttack(player, direction, false);</b>
<b class="fc">&nbsp;        player.changeDirection(direction);</b>
<b class="fc">&nbsp;        player.emitEvent(new PlayerAttackEventResponse(player, event, true));</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public KungFuType kungFuType() {
<b class="nc">&nbsp;        return getType().toKungFuType();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int recovery() {
<b class="fc">&nbsp;        return parameters.recovery();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int attackSpeed() {
<b class="fc">&nbsp;        var innate = parameters.attackSpeed();</b>
<b class="fc">&nbsp;        return innate - innate * level() / INIT_SKILL_DIV_ATTACKSPEED;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int bodyArmor() {
<b class="fc">&nbsp;        return applyLevelToArmor(parameters.bodyArmor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int avoidance() {
<b class="fc">&nbsp;        return parameters.avoidance();</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public int bodyDamage() {
&nbsp;        /*
&nbsp;      rcLifeData.DamageBody   := rLifeData.damageBody  + rLifeData.damageBody * rcSkillLevel div INI_SKILL_DIV_DAMAGE;
&nbsp;      rcLifeData.DamageHead   := rLifeData.DamageHead  + rLifeData.damageHead * rcSkillLevel div INI_SKILL_DIV_DAMAGE;
&nbsp;      rcLifeData.DamageArm    := rLifeData.DamageArm   + rLifeData.damageArm  * rcSkillLevel div INI_SKILL_DIV_DAMAGE;
&nbsp;      rcLifeData.DamageLeg    := rLifeData.DamageLeg   + rLifeData.damageLeg  * rcSkillLevel div INI_SKILL_DIV_DAMAGE;
&nbsp;      rcLifeData.AttackSpeed  := rLifeData.AttackSpeed - rLifeData.AttackSpeed * rcSkillLevel div INI_SKILL_DIV_ATTACKSPEED;
&nbsp;      rcLifeData.avoid        := rLifeData.avoid   ;//    + rLifeData.avoid;
&nbsp;      rcLifeData.recovery     := rLifeData.recovery;//    + rLifeData.recovery;
&nbsp;      rcLifeData.armorBody    := rLifeData.armorBody   + rLifeData.armorBody * rcSkillLevel div INI_SKILL_DIV_ARMOR;
&nbsp;      rcLifeData.armorHead    := rLifeData.armorHead   + rLifeData.armorHead * rcSkillLevel div INI_SKILL_DIV_ARMOR;
&nbsp;      rcLifeData.armorArm     := rLifeData.armorArm    + rLifeData.armorArm  * rcSkillLevel div INI_SKILL_DIV_ARMOR;
&nbsp;      rcLifeData.armorLeg     := rLifeData.armorLeg    + rLifeData.armorLeg  * rcSkillLevel div INI_SKILL_DIV_ARMOR;
&nbsp;         */
<b class="fc">&nbsp;        int val = applyLevelToDamage(parameters.bodyDamage());</b>
<b class="fc">&nbsp;        return DAMAGE_MULTIPLIERS.stream()</b>
<b class="fc">&nbsp;                .filter(m -&gt; m.contains(level()))</b>
<b class="fc">&nbsp;                .findAny()</b>
<b class="fc">&nbsp;                .map(m -&gt; m.multiply(val))</b>
<b class="fc">&nbsp;                .orElse(val);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Armor armor() {
<b class="fc">&nbsp;        return new Armor(bodyArmor(), headArmor(), armArmor(), legArmor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private int applyLevelToDamage(int damage) {
<b class="fc">&nbsp;        return damage + damage * level() / INIT_SKILL_DIV_DAMAGE;</b>
&nbsp;    }
&nbsp;
&nbsp;    private int applyLevelToArmor(int armor) {
<b class="fc">&nbsp;        return armor + armor * level() / INIT_SKILL_DIV_ARMOR;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int headDamage() {
<b class="fc">&nbsp;        return applyLevelToDamage(parameters.headDamage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int legDamage() {
<b class="fc">&nbsp;        return applyLevelToDamage(parameters.legDamage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int armDamage() {
<b class="fc">&nbsp;        return applyLevelToDamage(parameters.armDamage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int headArmor() {
<b class="fc">&nbsp;        return applyLevelToArmor(parameters.headArmor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int armArmor() {
<b class="fc">&nbsp;        return applyLevelToArmor(parameters.armArmor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int legArmor() {
<b class="fc">&nbsp;        return applyLevelToArmor(parameters.legArmor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Damage damage() {
<b class="fc">&nbsp;        return new Damage(bodyDamage(), headDamage(), armDamage(), legDamage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String description() {
<b class="fc">&nbsp;        StringBuilder descriptionBuilder = getDescriptionBuilder();</b>
<b class="fc">&nbsp;        descriptionBuilder.append(&quot;攻击速度: &quot;).append(attackSpeed()).append(&quot;\n&quot;)</b>
<b class="fc">&nbsp;                .append(&quot;恢复: &quot;).append(recovery()).append(&quot;\n&quot;)</b>
<b class="fc">&nbsp;                .append(&quot;闪躲: &quot;).append(avoidance()).append(&quot;\n&quot;);</b>
<b class="fc">&nbsp;        var dmg = damage();</b>
<b class="fc">&nbsp;        var dmgStr = String.format(&quot;破坏力 : %d / %d / %d / %d&quot;, dmg.bodyDamage(), dmg.headDamage(), dmg.armDamage(), dmg.legDamage());</b>
<b class="fc">&nbsp;        descriptionBuilder.append(dmgStr).append(&quot;\n&quot;);</b>
<b class="fc">&nbsp;        var am = armor();</b>
<b class="fc">&nbsp;        var str = String.format(&quot;防御力: %d / %d / %d / %d&quot;, am.body(), am.head(), am.arm(), am.leg());</b>
<b class="fc">&nbsp;        return descriptionBuilder.append(str).append(&quot;\n&quot;).toString();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-07-18 11:06</div>
</div>
</body>
</html>
